{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.EstimatedDocumentCountOperation = void 0;\n\nconst operation_1 = require(\"./operation\");\n\nconst command_1 = require(\"./command\");\n\nconst utils_1 = require(\"../utils\");\n/** @internal */\n\n\nclass EstimatedDocumentCountOperation extends command_1.CommandOperation {\n  constructor(collection, options = {}) {\n    super(collection, options);\n    this.options = options;\n    this.collectionName = collection.collectionName;\n  }\n\n  execute(server, session, callback) {\n    if (utils_1.maxWireVersion(server) < 12) {\n      return this.executeLegacy(server, session, callback);\n    }\n\n    const pipeline = [{\n      $collStats: {\n        count: {}\n      }\n    }, {\n      $group: {\n        _id: 1,\n        n: {\n          $sum: '$count'\n        }\n      }\n    }];\n    const cmd = {\n      aggregate: this.collectionName,\n      pipeline,\n      cursor: {}\n    };\n\n    if (typeof this.options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = this.options.maxTimeMS;\n    }\n\n    super.executeCommand(server, session, cmd, (err, response) => {\n      var _a, _b;\n\n      if (err && err.code !== 26) {\n        callback(err);\n        return;\n      }\n\n      callback(undefined, ((_b = (_a = response === null || response === void 0 ? void 0 : response.cursor) === null || _a === void 0 ? void 0 : _a.firstBatch[0]) === null || _b === void 0 ? void 0 : _b.n) || 0);\n    });\n  }\n\n  executeLegacy(server, session, callback) {\n    const cmd = {\n      count: this.collectionName\n    };\n\n    if (typeof this.options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = this.options.maxTimeMS;\n    }\n\n    super.executeCommand(server, session, cmd, (err, response) => {\n      if (err) {\n        callback(err);\n        return;\n      }\n\n      callback(undefined, response.n || 0);\n    });\n  }\n\n}\n\nexports.EstimatedDocumentCountOperation = EstimatedDocumentCountOperation;\noperation_1.defineAspects(EstimatedDocumentCountOperation, [operation_1.Aspect.READ_OPERATION, operation_1.Aspect.RETRYABLE, operation_1.Aspect.CURSOR_CREATING]);","map":{"version":3,"names":["Object","defineProperty","exports","value","EstimatedDocumentCountOperation","operation_1","require","command_1","utils_1","CommandOperation","constructor","collection","options","collectionName","execute","server","session","callback","maxWireVersion","executeLegacy","pipeline","$collStats","count","$group","_id","n","$sum","cmd","aggregate","cursor","maxTimeMS","executeCommand","err","response","_a","_b","code","undefined","firstBatch","defineAspects","Aspect","READ_OPERATION","RETRYABLE","CURSOR_CREATING"],"sources":["/Users/yoannesfigueiras/node_modules/mongodb/lib/operations/estimated_document_count.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.EstimatedDocumentCountOperation = void 0;\nconst operation_1 = require(\"./operation\");\nconst command_1 = require(\"./command\");\nconst utils_1 = require(\"../utils\");\n/** @internal */\nclass EstimatedDocumentCountOperation extends command_1.CommandOperation {\n    constructor(collection, options = {}) {\n        super(collection, options);\n        this.options = options;\n        this.collectionName = collection.collectionName;\n    }\n    execute(server, session, callback) {\n        if (utils_1.maxWireVersion(server) < 12) {\n            return this.executeLegacy(server, session, callback);\n        }\n        const pipeline = [{ $collStats: { count: {} } }, { $group: { _id: 1, n: { $sum: '$count' } } }];\n        const cmd = { aggregate: this.collectionName, pipeline, cursor: {} };\n        if (typeof this.options.maxTimeMS === 'number') {\n            cmd.maxTimeMS = this.options.maxTimeMS;\n        }\n        super.executeCommand(server, session, cmd, (err, response) => {\n            var _a, _b;\n            if (err && err.code !== 26) {\n                callback(err);\n                return;\n            }\n            callback(undefined, ((_b = (_a = response === null || response === void 0 ? void 0 : response.cursor) === null || _a === void 0 ? void 0 : _a.firstBatch[0]) === null || _b === void 0 ? void 0 : _b.n) || 0);\n        });\n    }\n    executeLegacy(server, session, callback) {\n        const cmd = { count: this.collectionName };\n        if (typeof this.options.maxTimeMS === 'number') {\n            cmd.maxTimeMS = this.options.maxTimeMS;\n        }\n        super.executeCommand(server, session, cmd, (err, response) => {\n            if (err) {\n                callback(err);\n                return;\n            }\n            callback(undefined, response.n || 0);\n        });\n    }\n}\nexports.EstimatedDocumentCountOperation = EstimatedDocumentCountOperation;\noperation_1.defineAspects(EstimatedDocumentCountOperation, [\n    operation_1.Aspect.READ_OPERATION,\n    operation_1.Aspect.RETRYABLE,\n    operation_1.Aspect.CURSOR_CREATING\n]);\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}