{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.makeDeleteStatement = exports.DeleteManyOperation = exports.DeleteOneOperation = exports.DeleteOperation = void 0;\n\nconst operation_1 = require(\"./operation\");\n\nconst command_1 = require(\"./command\");\n\nconst utils_1 = require(\"../utils\");\n\nconst error_1 = require(\"../error\");\n/** @internal */\n\n\nclass DeleteOperation extends command_1.CommandOperation {\n  constructor(ns, statements, options) {\n    super(undefined, options);\n    this.options = options;\n    this.ns = ns;\n    this.statements = statements;\n  }\n\n  get canRetryWrite() {\n    if (super.canRetryWrite === false) {\n      return false;\n    }\n\n    return this.statements.every(op => op.limit != null ? op.limit > 0 : true);\n  }\n\n  execute(server, session, callback) {\n    var _a;\n\n    const options = (_a = this.options) !== null && _a !== void 0 ? _a : {};\n    const ordered = typeof options.ordered === 'boolean' ? options.ordered : true;\n    const command = {\n      delete: this.ns.collection,\n      deletes: this.statements,\n      ordered\n    };\n\n    if (options.let) {\n      command.let = options.let;\n    }\n\n    if (options.explain != null && utils_1.maxWireVersion(server) < 3) {\n      return callback ? callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support explain on delete`)) : undefined;\n    }\n\n    const unacknowledgedWrite = this.writeConcern && this.writeConcern.w === 0;\n\n    if (unacknowledgedWrite || utils_1.maxWireVersion(server) < 5) {\n      if (this.statements.find(o => o.hint)) {\n        callback(new error_1.MongoCompatibilityError(`Servers < 3.4 do not support hint on delete`));\n        return;\n      }\n    }\n\n    const statementWithCollation = this.statements.find(statement => !!statement.collation);\n\n    if (statementWithCollation && utils_1.collationNotSupported(server, statementWithCollation)) {\n      callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support collation`));\n      return;\n    }\n\n    super.executeCommand(server, session, command, callback);\n  }\n\n}\n\nexports.DeleteOperation = DeleteOperation;\n\nclass DeleteOneOperation extends DeleteOperation {\n  constructor(collection, filter, options) {\n    super(collection.s.namespace, [makeDeleteStatement(filter, { ...options,\n      limit: 1\n    })], options);\n  }\n\n  execute(server, session, callback) {\n    super.execute(server, session, (err, res) => {\n      var _a, _b;\n\n      if (err || res == null) return callback(err);\n      if (res.code) return callback(new error_1.MongoServerError(res));\n      if (res.writeErrors) return callback(new error_1.MongoServerError(res.writeErrors[0]));\n      if (this.explain) return callback(undefined, res);\n      callback(undefined, {\n        acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n        deletedCount: res.n\n      });\n    });\n  }\n\n}\n\nexports.DeleteOneOperation = DeleteOneOperation;\n\nclass DeleteManyOperation extends DeleteOperation {\n  constructor(collection, filter, options) {\n    super(collection.s.namespace, [makeDeleteStatement(filter, options)], options);\n  }\n\n  execute(server, session, callback) {\n    super.execute(server, session, (err, res) => {\n      var _a, _b;\n\n      if (err || res == null) return callback(err);\n      if (res.code) return callback(new error_1.MongoServerError(res));\n      if (res.writeErrors) return callback(new error_1.MongoServerError(res.writeErrors[0]));\n      if (this.explain) return callback(undefined, res);\n      callback(undefined, {\n        acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n        deletedCount: res.n\n      });\n    });\n  }\n\n}\n\nexports.DeleteManyOperation = DeleteManyOperation;\n\nfunction makeDeleteStatement(filter, options) {\n  const op = {\n    q: filter,\n    limit: typeof options.limit === 'number' ? options.limit : 0\n  };\n\n  if (options.single === true) {\n    op.limit = 1;\n  }\n\n  if (options.collation) {\n    op.collation = options.collation;\n  }\n\n  if (options.hint) {\n    op.hint = options.hint;\n  }\n\n  if (options.comment) {\n    op.comment = options.comment;\n  }\n\n  return op;\n}\n\nexports.makeDeleteStatement = makeDeleteStatement;\noperation_1.defineAspects(DeleteOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION]);\noperation_1.defineAspects(DeleteOneOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION, operation_1.Aspect.EXPLAINABLE, operation_1.Aspect.SKIP_COLLATION]);\noperation_1.defineAspects(DeleteManyOperation, [operation_1.Aspect.WRITE_OPERATION, operation_1.Aspect.EXPLAINABLE, operation_1.Aspect.SKIP_COLLATION]);","map":{"version":3,"names":["Object","defineProperty","exports","value","makeDeleteStatement","DeleteManyOperation","DeleteOneOperation","DeleteOperation","operation_1","require","command_1","utils_1","error_1","CommandOperation","constructor","ns","statements","options","undefined","canRetryWrite","every","op","limit","execute","server","session","callback","_a","ordered","command","delete","collection","deletes","let","explain","maxWireVersion","MongoCompatibilityError","name","unacknowledgedWrite","writeConcern","w","find","o","hint","statementWithCollation","statement","collation","collationNotSupported","executeCommand","filter","s","namespace","err","res","_b","code","MongoServerError","writeErrors","acknowledged","deletedCount","n","q","single","comment","defineAspects","Aspect","RETRYABLE","WRITE_OPERATION","EXPLAINABLE","SKIP_COLLATION"],"sources":["/Users/yoannesfigueiras/node_modules/mongodb/lib/operations/delete.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.makeDeleteStatement = exports.DeleteManyOperation = exports.DeleteOneOperation = exports.DeleteOperation = void 0;\nconst operation_1 = require(\"./operation\");\nconst command_1 = require(\"./command\");\nconst utils_1 = require(\"../utils\");\nconst error_1 = require(\"../error\");\n/** @internal */\nclass DeleteOperation extends command_1.CommandOperation {\n    constructor(ns, statements, options) {\n        super(undefined, options);\n        this.options = options;\n        this.ns = ns;\n        this.statements = statements;\n    }\n    get canRetryWrite() {\n        if (super.canRetryWrite === false) {\n            return false;\n        }\n        return this.statements.every(op => (op.limit != null ? op.limit > 0 : true));\n    }\n    execute(server, session, callback) {\n        var _a;\n        const options = (_a = this.options) !== null && _a !== void 0 ? _a : {};\n        const ordered = typeof options.ordered === 'boolean' ? options.ordered : true;\n        const command = {\n            delete: this.ns.collection,\n            deletes: this.statements,\n            ordered\n        };\n        if (options.let) {\n            command.let = options.let;\n        }\n        if (options.explain != null && utils_1.maxWireVersion(server) < 3) {\n            return callback\n                ? callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support explain on delete`))\n                : undefined;\n        }\n        const unacknowledgedWrite = this.writeConcern && this.writeConcern.w === 0;\n        if (unacknowledgedWrite || utils_1.maxWireVersion(server) < 5) {\n            if (this.statements.find((o) => o.hint)) {\n                callback(new error_1.MongoCompatibilityError(`Servers < 3.4 do not support hint on delete`));\n                return;\n            }\n        }\n        const statementWithCollation = this.statements.find(statement => !!statement.collation);\n        if (statementWithCollation && utils_1.collationNotSupported(server, statementWithCollation)) {\n            callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support collation`));\n            return;\n        }\n        super.executeCommand(server, session, command, callback);\n    }\n}\nexports.DeleteOperation = DeleteOperation;\nclass DeleteOneOperation extends DeleteOperation {\n    constructor(collection, filter, options) {\n        super(collection.s.namespace, [makeDeleteStatement(filter, { ...options, limit: 1 })], options);\n    }\n    execute(server, session, callback) {\n        super.execute(server, session, (err, res) => {\n            var _a, _b;\n            if (err || res == null)\n                return callback(err);\n            if (res.code)\n                return callback(new error_1.MongoServerError(res));\n            if (res.writeErrors)\n                return callback(new error_1.MongoServerError(res.writeErrors[0]));\n            if (this.explain)\n                return callback(undefined, res);\n            callback(undefined, {\n                acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n                deletedCount: res.n\n            });\n        });\n    }\n}\nexports.DeleteOneOperation = DeleteOneOperation;\nclass DeleteManyOperation extends DeleteOperation {\n    constructor(collection, filter, options) {\n        super(collection.s.namespace, [makeDeleteStatement(filter, options)], options);\n    }\n    execute(server, session, callback) {\n        super.execute(server, session, (err, res) => {\n            var _a, _b;\n            if (err || res == null)\n                return callback(err);\n            if (res.code)\n                return callback(new error_1.MongoServerError(res));\n            if (res.writeErrors)\n                return callback(new error_1.MongoServerError(res.writeErrors[0]));\n            if (this.explain)\n                return callback(undefined, res);\n            callback(undefined, {\n                acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n                deletedCount: res.n\n            });\n        });\n    }\n}\nexports.DeleteManyOperation = DeleteManyOperation;\nfunction makeDeleteStatement(filter, options) {\n    const op = {\n        q: filter,\n        limit: typeof options.limit === 'number' ? options.limit : 0\n    };\n    if (options.single === true) {\n        op.limit = 1;\n    }\n    if (options.collation) {\n        op.collation = options.collation;\n    }\n    if (options.hint) {\n        op.hint = options.hint;\n    }\n    if (options.comment) {\n        op.comment = options.comment;\n    }\n    return op;\n}\nexports.makeDeleteStatement = makeDeleteStatement;\noperation_1.defineAspects(DeleteOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION]);\noperation_1.defineAspects(DeleteOneOperation, [\n    operation_1.Aspect.RETRYABLE,\n    operation_1.Aspect.WRITE_OPERATION,\n    operation_1.Aspect.EXPLAINABLE,\n    operation_1.Aspect.SKIP_COLLATION\n]);\noperation_1.defineAspects(DeleteManyOperation, [\n    operation_1.Aspect.WRITE_OPERATION,\n    operation_1.Aspect.EXPLAINABLE,\n    operation_1.Aspect.SKIP_COLLATION\n]);\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}